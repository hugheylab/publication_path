{% extends 'base.html' %}

{% block navbar %}
  <p>Step 1: Search&nbsp;&nbsp;→&nbsp;&nbsp;
  <b>Step 2: {% block title %}Select{% endblock %} Papers and Emails</b>&nbsp;&nbsp;→&nbsp;&nbsp;
  Step 3: Enter Steps&nbsp;&nbsp;→&nbsp;&nbsp;
  Step 4: Confirm Information</p>
{% endblock %}

{% block content %}
  <form method="post">
    <table style="width:100%;border-spacing: 0px;">
      <tr>
        <td style="width: 75%; border-bottom: 1px solid black;vertical-align: top;">
          <!--<b>Article Information</b>-->
          <b>Instructions: </b>
          <ol>
            <li>Please confirm that the paper(s) listed are correct.</li>
            <li>Select each email address per article you wish to send a link to. Selecing an email to the right will select all instances of that email found.</li>
            <li>You can click "Show/Hide Information" to view additional information (DOI, affiliations, etc.).</li>
            <li>If you need to go back to search again, click "Back" to return to the search screen and refine your search.</li>
            <li>Once you have selected all email addresses per article to send links to, click "Confirm" to generate and send out the links.</li>
          </ol>
        </td>
        <td style="width: 25%; border-bottom: 1px solid black; vertical-align: top;">
            {% if email_list %}
            <b>Toggle email for each instance:</b><br/>
            {% for email in email_list %}
              <input type="checkbox" name="{{email}}" id="{{email}}" onClick="selectAll(this)" />&nbsp;{{email}}<br/>
            {% endfor %}
          {% endif %}
        </td>
      </tr>
      {% for article_info in article_infos %}
        <tr>
          <td style="width: 75%; border-bottom: 1px solid black;">
            <b>{{ article_info.article.title }}</b><br/>
            {% for author in article_info.authors %}
                {{author.author['author_name']}}<sup>{% for affiliation in author.affiliation_nums %}{{affiliation}}{% if not loop.last %},&nbsp;{% endif %}{% endfor %}</sup>{% if not loop.last %},&nbsp; {% endif %}
            {% endfor %}<br/>
            {{ article_info.article.journal_name }}, {{ article_info.article.pub_date }}<br/>
            {% if article_info.has_path == True %}<b style="color: orange;">*Path has already been entered for this article. You can still resend links to re-enter if desired!</b><br/>{% endif %}
            <button class="btn btn-info" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{loop.index}}" aria-expanded="false" aria-controls="collapse-{{loop.index}}">Show/Hide more information</button>
            <div class="collapse" id="collapse-{{loop.index}}">
              <div class="card card-body">
                Affiliations:<br/>
                {% for affiliation in article_info.affiliation_list %}
                    {{ loop.index }}.&nbsp;{{affiliation}}<br/>
                {% endfor %}<br/>
                DOI:&nbsp;{{ article_info.article.doi }}<br/>
                PMID:&nbsp;{{ article_info.article.pmid }}<br/>
              </div>
            </div><br/><br/>
          </td>
          <td style="width: 25%; border-bottom: 1px solid black; vertical-align: top;">
            {% if article_info.has_emails == True %}
              <br/>
              {% for email in article_info.emails %}
                  <input class="checkable" type="checkbox" name="{{article_info.article.doi + '---' + email.email}}" id="{{article_info.article.doi + '---' + email.email}}" />&nbsp;{{email.email}}<!--&nbsp;&nbsp;(Source: {{email.source}})--><br/>
              {% endfor %}
            {% else %}
              <h3>No emails addresses found.</h3>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </table>
    <br/><input name="back" class="btn btn-secondary" type="submit" value="Back">&nbsp;&nbsp;&nbsp;{% if all_has_emails == True %}<input type="submit" class="btn btn-success" value="Confirm">{% endif %}
  </form>
  <script>
    function selectAll(source) {
      var email = source.getAttribute("name");
      var elmnts = document.getElementsByTagName("input");
      for (var i = 0; i < elmnts.length;i++) {
        if (elmnts[i].getAttribute("type") == "checkbox" && elmnts[i].getAttribute("name").includes("---")) {
          tmp_arr = elmnts[i].getAttribute("name").split("---");
          if (email == tmp_arr[1]) {
            elmnts[i].checked = source.checked;
          }
        }
      }
    }
    </script>
{% endblock %}